
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>P1505 [国家集训队]旅游 | Steven_Meng&#39;s Blog</title>
<meta name="description" content="白鳥は　かなしからずや　空の青 海のあをにも　染まずただよふ">
<meta name="referrer" content="no-referrer" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://steven-mhy.github.io/favicon.ico?v=1571391316490">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://steven-mhy.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://steven-mhy.github.io">
        <img class="avatar" src="https://steven-mhy.github.io/images/avatar.png?v=1571391316490" alt="" width="32px" height="32px">
      </a>
      <a href="https://steven-mhy.github.io">
        <h1 class="site-title">Steven_Meng&#39;s Blog</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">P1505 [国家集训队]旅游</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2019-07-30</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://steven-mhy.github.io/tag/tz8jnsnOVd">
                    题解
                    
                      ，
                    
                  </a>
                
                  <a href="https://steven-mhy.github.io/tag/915M0pAYLA6">
                    线段树
                    
                      ，
                    
                  </a>
                
                  <a href="https://steven-mhy.github.io/tag/5IAZYzF_y6F">
                    树链剖分
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <p><a href="https://www.luogu.org/problem/P1505">传送门</a></p>
<p>线段树实现区间查询最大值，查询最小值，查询和，区间<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>∗</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">*-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，前面<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>种都没有什么好讲的，最后一种就是把区间和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>∗</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">*-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，最小值，最大值交换以后<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>∗</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">*-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></p>
<p>注意：下标从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>开始。</p>
<pre><code class="language-cpp">// luogu-judger-enable-o2
#include &lt;iostream&gt;
#include &lt;cstdio&gt;
#include &lt;vector&gt;
#define MAXN 30005
using namespace std;
inline int read(){
	int x=0,f=1;
	char ch=getchar();
	while (ch&lt;'0'||ch&gt;'9'){
		if (ch=='-') f=-1;
		ch=getchar();
	}
	while (ch&lt;='9'&amp;&amp;ch&gt;='0'){
		x=(x&lt;&lt;3)+(x&lt;&lt;1)+ch-'0';
		ch=getchar();
	}
	return x*f;
}
struct edge{
	int to,cost;
};
vector&lt;edge&gt;G[MAXN];
inline void add_edge(int u,int v,int w){
	edge temp;
	temp.to=v;
	temp.cost=w;
	G[u].push_back(temp);
}
int value[MAXN],size[MAXN],fa[MAXN],dep[MAXN],top[MAXN],id[MAXN],Bigson[MAXN];
int cnt;
int tofa[MAXN],pre[MAXN];
void dfs(int u,int father){
	size[u]=1;
	dep[u]=dep[father]+1;
	for (register int i=0;i&lt;G[u].size();i++){
		int v=G[u][i].to;
		int w=G[u][i].cost;
		if (v!=father){
			fa[v]=u;
			dfs(v,u);
			tofa[v]=w;
			size[u]+=size[v];
			if (size[v]&gt;size[Bigson[u]]){
				Bigson[u]=v;
			}
		}
	}
}
void dfs2(int u,int Top){
	top[u]=Top;
	pre[id[u]=++cnt]=u;
	if (Bigson[u]){
		dfs2(Bigson[u],Top);
	}
	for (register int i=0;i&lt;G[u].size();i++){
		if (G[u][i].to!=fa[u]&amp;&amp;G[u][i].to!=Bigson[u]){
			dfs2(G[u][i].to,G[u][i].to);
		}
	}
}
#define lc i&lt;&lt;1
#define rc i&lt;&lt;1|1
struct SegmentTree{
	struct node{
		int l,r;
		int sum,revtag;//tag==-1需要变成相反数 
		int maxval,minval;
	}tree[MAXN&lt;&lt;2];
	inline void Swap(int i){
		swap(tree[i].maxval,tree[i].minval);
		tree[i].maxval*=-1,tree[i].minval*=-1;
	}
	inline void pushdown(int i){
		if (tree[i].revtag==-1){
			tree[lc].revtag*=-1;
			tree[rc].revtag*=-1;
			tree[lc].sum=-tree[lc].sum;
			tree[rc].sum=-tree[rc].sum;
			Swap(lc),Swap(rc);
			tree[i].revtag=1;
		}
	}
	inline void pushup(int i){
		tree[i].sum=tree[lc].sum+tree[rc].sum;
		tree[i].maxval=max(tree[lc].maxval,tree[rc].maxval);
		tree[i].minval=min(tree[lc].minval,tree[rc].minval);
	}
	void build(int l,int r,int i){
		tree[i].l=l,tree[i].r=r;
		tree[i].revtag=1;
		if (l==r){
			tree[i].maxval=tree[i].minval=tree[i].sum=tofa[pre[l]];
			return ;
		}
		int mid=(l+r)&gt;&gt;1;
		build(l,mid,lc);
		build(mid+1,r,rc);
		pushup(i);
	}
	void update_pos(int pos,int v,int i){
		int l=tree[i].l,r=tree[i].r;
		if (l==r){
			tree[i].sum=tree[i].maxval=tree[i].minval=v;
			return ;
		}
		pushdown(i);
		int mid=(l+r)&gt;&gt;1;
		if (pos&lt;=mid) update_pos(pos,v,lc);
		else update_pos(pos,v,rc);
		pushup(i);
	}
	void rever(int L,int R,int i){
		int l=tree[i].l,r=tree[i].r;
		if (L&lt;=l&amp;&amp;r&lt;=R){
			tree[i].sum*=-1;
			Swap(i);
			tree[i].revtag*=-1;
			return ;
		}
		pushdown(i);
		int mid=(l+r)&gt;&gt;1;
		if (L&lt;=mid) rever(L,R,lc);
		if (mid&lt;R) rever(L,R,rc);
		pushup(i);
	}
	int query_sum(int L,int R,int i){
		int l=tree[i].l,r=tree[i].r;
		if (L&lt;=l&amp;&amp;r&lt;=R){
			return tree[i].sum;
		}
		int mid=(l+r)&gt;&gt;1;
		int ans=0;
		pushdown(i);
		if (L&lt;=mid) ans+=query_sum(L,R,lc);
		if (mid&lt;R) ans+=query_sum(L,R,rc);
		return ans;
	}
	int query_max(int L,int R,int i){
		int l=tree[i].l,r=tree[i].r;
		if (L&lt;=l&amp;&amp;r&lt;=R){
			return tree[i].maxval;
		}
		pushdown(i);
		int mid=(l+r)&gt;&gt;1;
		int ans=-0x7fffffff;
		if (L&lt;=mid) ans=max(ans,query_max(L,R,lc));
		if (mid&lt;R) ans=max(ans,query_max(L,R,rc));
		return ans;
	}
	int query_min(int L,int R,int i){
		int l=tree[i].l,r=tree[i].r;
		if (L&lt;=l&amp;&amp;r&lt;=R){
			return tree[i].minval;
		}
		pushdown(i);
		int mid=(l+r)&gt;&gt;1;
		int ans=0x7fffffff;
		if (L&lt;=mid) ans=min(ans,query_min(L,R,lc));
		if (mid&lt;R) ans=min(ans,query_min(L,R,rc));
		return ans;
	}
	#undef lc
	#undef rc
}Seg;
inline int query_ans(int u,int v){
	int sum=0;
	while (top[u]!=top[v]){
		if (dep[top[u]]&lt;dep[top[v]]) swap(u,v);
		sum+=Seg.query_sum(id[top[u]],id[u],1);
		u=fa[top[u]];
	}
	if (u==v) return sum;
	if (id[u]&gt;id[v]) swap(u,v);
	sum+=Seg.query_sum(id[u]+1,id[v],1);
	return sum;
}
inline int query_maxval(int u,int v){
	int maxn=-0x7fffffff;
	while (top[u]!=top[v]){
		if (dep[top[u]]&lt;dep[top[v]]) swap(u,v);
		maxn=max(maxn,Seg.query_max(id[top[u]],id[u],1));
		u=fa[top[u]];
	}
	if (u==v) return maxn;
	if (id[u]&gt;id[v]) swap(u,v);
	maxn=max(maxn,Seg.query_max(id[u]+1,id[v],1));
	return maxn;
}
inline int query_minval(int u,int v){
	int mino=0x7fffffff;
	while (top[u]!=top[v]){
		if (dep[top[u]]&lt;dep[top[v]]) swap(u,v);
		mino=min(mino,Seg.query_min(id[top[u]],id[u],1));
		u=fa[top[u]];
	}
	if (u==v) return mino;
	if (id[u]&gt;id[v]) swap(u,v);
	mino=min(mino,Seg.query_min(id[u]+1,id[v],1));
	return mino;
}
inline void update_tree(int u,int v){
	while (top[u]!=top[v]){
		if (dep[top[u]]&lt;dep[top[v]]) swap(u,v);
		Seg.rever(id[top[u]],id[u],1);
		u=fa[top[u]];
	}
	if (u==v) return ;
	if (id[u]&gt;id[v]) swap(u,v);
	Seg.rever(id[u]+1,id[v],1);
}
char str[10];
int main(){
	int n=read();
	for (register int i=1;i&lt;n;i++){
		int u=read()+1,v=read()+1,w=read();
		add_edge(u,v,w);
		add_edge(v,u,w);
	}
	dfs(1,1);
	dfs2(1,1);
	Seg.build(1,n,1);
	int q=read();
	while (q--){
		scanf(&quot;%s&quot;,str);
		if (str[0]=='C'){
			int v=read()+1,w=read();
			Seg.update_pos(id[v],w,1);
			continue;
		}
		int u=read()+1,v=read()+1;
		if (str[0]=='N'){
			update_tree(u,v);
		}
		else if (str[0]=='S'){
			printf(&quot;%d\n&quot;,query_ans(u,v));
		}
		else if (str[1]=='A'){
			printf(&quot;%d\n&quot;,query_maxval(u,v));
		}
		else if (str[1]=='I'){
			printf(&quot;%d\n&quot;,query_minval(u,v));
		}
	}
}
</code></pre>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://steven-mhy.github.io/post/CF735D-Taxes">
              <h3 class="post-title">
                下一篇：CF735D Taxes
              </h3>
            </a>
          </div>
          
      </div>

      
        
          <div id="gitalk-container"></div>
        

        
      

      <div class="site-footer">
  <div class="slogan">白鳥は　かなしからずや　空の青 海のあをにも　染まずただよふ</div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://steven-mhy.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '0381bd48f354d449038e',
        clientSecret: 'a325a1b671eb2071d75fc107561dfeedaa1485cf',
        repo: 'steven-mhy.github.io',
        owner: 'steven-mhy',
        admin: ['steven-mhy'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
